name: Ejecutar Scraper y Verificador de Cursos v4
on:
  schedule:
    - cron: '0 3 */2 * *' # Cada 2 d√≠as a las 9:00 PM M√©xico (3:00 AM UTC)
  workflow_dispatch:

jobs:
  scraper-y-verificador:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üîç Debug - Verificar variables de entorno
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_PORT: ${{ secrets.DB_PORT }}
        run: |
          echo "üîç Verificando variables de entorno..."
          echo "DB_HOST: $DB_HOST"
          echo "DB_USER: $DB_USER"
          echo "DB_NAME: $DB_NAME"
          echo "DB_PORT: ${DB_PORT:-3306}"
          echo "DB_PASS: $(echo $DB_PASS | head -c 3)***"

      - name: 1Ô∏è‚É£ Ejecutar scraper de Multiplatorma
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_PORT: ${{ secrets.DB_PORT || 3306 }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "üîç Iniciando scraper de Multiplataforma..."
          echo "üîó Conectando a: $DB_HOST:${DB_PORT:-3306}"
          echo "üë§ Usuario: $DB_USER"
          echo "üóÑÔ∏è Base de datos: $DB_NAME"
          python data/scraper_multiplataforma.py
          echo "‚úÖ Scraper de Multiplataforma completado"

      - name: 1Ô∏è‚É£ Ejecutar scraper de Discudemy
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_PORT: ${{ secrets.DB_PORT || 3306 }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "üîç Iniciando scraper de Discudemy..."
          echo "üîó Conectando a: $DB_HOST:${DB_PORT:-3306}"
          echo "üë§ Usuario: $DB_USER"
          echo "üóÑÔ∏è Base de datos: $DB_NAME"
          python data/scraper_discudemy.py
          echo "‚úÖ Scraper de Discudemy completado"

      - name: 2Ô∏è‚É£ Ejecutar verificador de cursos
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_PORT: ${{ secrets.DB_PORT || '3306' }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "üîç Iniciando verificador de cursos..."
          echo "üîó Conectando a: $DB_HOST:${DB_PORT:-3306}"
          python data/verificador_cursos.py
          echo "‚úÖ Verificador de cursos completado"

      - name: ‚úÖ Proceso completado exitosamente
        if: success()
        run: |
          echo "üéâ Ambos scripts ejecutados exitosamente"
          echo "‚è∞ Fecha y hora: $(date)"
          echo "üìä Scraper Discudemy & Multiplataforma  ‚úÖ"
          echo "üîç Verificador de cursos ‚úÖ"

      - name: ‚ùå Error en el proceso
        if: failure()
        run: |
          echo "üí• Error durante la ejecuci√≥n"
          echo "‚è∞ Fecha y hora: $(date)"
          echo "‚ÑπÔ∏è Revisa los logs anteriores para m√°s detalles"
